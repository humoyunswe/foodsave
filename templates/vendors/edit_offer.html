{% extends 'base.html' %}
{% load static %}

{% block title %}Редактировать предложение - {{ item.title }}{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-wrapper">
        <!-- Left Column - Branding -->
        <div class="login-left">
            <div class="brand-section">
                <div class="brand-logo">
                    <div class="logo-circle">
                        <span class="logo-text">FS</span>
                    </div>
                    <div class="brand-name">FOODSAVE</div>
                </div>
            </div>
            <div class="main-text">
                <div class="text-line">РЕДАКТИРОВАНИЕ</div>
                <div class="text-line">ПРЕДЛОЖЕНИЯ</div>
            </div>
        </div>

        <!-- Right Column - Form -->
        <div class="login-right">
            <div class="form-container">
                <h2 class="form-title">Редактировать предложение</h2>
                <p class="vendor-name">{{ vendor.name }} — {{ item.title }}</p>

                <form method="post" class="vendor-form needs-validation" novalidate>
                    {% csrf_token %}

                    <!-- Branch (read-only) -->
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Филиал</label>
                        <div class="form-control" style="background:#f1f5f9;">{{ item.branch.name }}</div>
                        <div class="form-text">Филиал наследуется от товара</div>
                    </div>

                    <!-- Pricing -->
                    <div class="form-group">
                        <label for="{{ form.original_price.id_for_label }}" class="form-label">Обычная цена *</label>
                        <div class="input-group">
                            {{ form.original_price }}
                            <span class="input-group-text">сум</span>
                        </div>
                        {% if form.original_price.errors %}
                            <div class="invalid-feedback d-block">{{ form.original_price.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.discount_percent.id_for_label }}" class="form-label">Скидка (%)</label>
                        <div class="input-group">
                            {{ form.discount_percent }}
                            <span class="input-group-text">%</span>
                        </div>
                        <div id="quick-discounts" class="mt-2"></div>
                        {% if form.discount_percent.errors %}
                            <div class="invalid-feedback d-block">{{ form.discount_percent.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label">Итоговая цена</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="final-price" readonly>
                            <span class="input-group-text">сум</span>
                        </div>
                    </div>

                    <!-- Quantity with +/- Controls -->
                    <div class="form-group">
                        <label for="{{ form.quantity.id_for_label }}" class="form-label">
                            <i class="fas fa-boxes me-2"></i>Количество
                        </label>
                        <div class="quantity-control-group">
                            <button type="button" class="quantity-btn quantity-decrease" onclick="changeQuantity(-1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            {{ form.quantity }}
                            <button type="button" class="quantity-btn quantity-increase" onclick="changeQuantity(1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">0 = неограниченно</div>
                        {% if form.quantity.errors %}
                            <div class="invalid-feedback d-block">{{ form.quantity.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Quick Quantity Presets -->
                    <div class="quick-quantity mb-4">
                        <small class="text-muted d-block mb-2">Быстрый выбор:</small>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info" onclick="setQuantity(0)">Неогр.</button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuantity(5)">5</button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuantity(10)">10</button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuantity(20)">20</button>
                            <button type="button" class="btn btn-outline-info" onclick="setQuantity(50)">50</button>
                        </div>
                    </div>

                    <!-- Date and Time Section -->
                    <div class="datetime-section">
                        <h6 class="section-title"><i class="fas fa-calendar-alt me-2"></i>Период действия</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Дата начала *</label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.start_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label">Время начала *</label>
                                    {{ form.start_time }}
                                    {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">{{ form.start_time.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">Дата окончания</label>
                                    {{ form.end_date }}
                                    <div class="form-text">Оставьте пустым для бессрочного</div>
                                    {% if form.end_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.end_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label">Время окончания</label>
                                    {{ form.end_time }}
                                    <div class="form-text">Оставьте пустым</div>
                                    {% if form.end_time.errors %}
                                        <div class="invalid-feedback d-block">{{ form.end_time.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Quick Time Presets -->
                        <div class="quick-times">
                            <small class="text-muted d-block mb-2">Быстрый выбор времени:</small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="setTimePreset('morning')">Утро</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setTimePreset('lunch')">Обед</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setTimePreset('evening')">Вечер</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setTimePreset('allday')">Весь день</button>
                            </div>
                        </div>
                    </div>

                    <!-- Non-field errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mt-3">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <!-- Status -->
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            {{ form.is_active }}
                            <span class="checkbox-text">Предложение активно</span>
                        </label>
                    </div>

                    <!-- Preview -->
                    <div class="card border-success mb-4" id="price-preview" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Предпросмотр</h6>
                        </div>
                        <div class="card-body text-center">
                            <div class="row">
                                <div class="col-4">
                                    <h6 class="text-muted">Обычная</h6>
                                    <h4 class="text-muted"><s><span id="preview-original">0</span> сум</s></h4>
                                </div>
                                <div class="col-4">
                                    <h6 class="text-warning">Скидка</h6>
                                    <h4 class="text-warning"><span id="preview-discount">0</span>%</h4>
                                </div>
                                <div class="col-4">
                                    <h6 class="text-success">Итого</h6>
                                    <h4 class="text-success"><span id="preview-final">0</span> сум</h4>
                                </div>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-info fs-6">
                                    <i class="fas fa-boxes me-1"></i>
                                    Кол-во: <span id="preview-quantity">0</span>
                                </span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    <span id="preview-period"></span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save me-2"></i>СОХРАНИТЬ
                        </button>
                        <a href="{% url 'vendors:manage_items' vendor.id %}" class="btn-secondary">Отмена</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
.login-wrapper { display: flex; width: 100%; max-width: 1400px; min-height: 100vh; background: white; }
.login-left { flex: 1; background: linear-gradient(135deg, #01605E 0%, #014a47 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; padding: 2rem; }
.brand-section { position: absolute; top: 2rem; left: 2rem; }
.brand-logo { display: flex; align-items: center; gap: 1rem; }
.logo-circle { width: 60px; height: 60px; background: rgba(255,255,255,.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,.3); }
.logo-text { color: #fff; font-size: 1.5rem; font-weight: 700; }
.brand-name { color: #fff; font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; }
.main-text { text-align: center; }
.text-line { color: #fff; font-size: 3rem; font-weight: 700; line-height: 1.2; margin-bottom: .5rem; text-shadow: 0 4px 8px rgba(0,0,0,.3); }

.login-right { flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 3rem 2rem 2rem; background: #fff; overflow-y: auto; }
.form-container { width: 100%; max-width: 600px; }
.form-title { color: #111827; font-size: 2rem; font-weight: 700; margin-bottom: .5rem; text-align: center; }
.vendor-name { color: #6b7280; font-size: 1rem; text-align: center; margin-bottom: 2rem; }

.vendor-form { width: 100%; }
.form-group { margin-bottom: 1.5rem; }
.form-label { display: block; color: #374151; font-weight: 600; margin-bottom: .5rem; font-size: .95rem; }
.form-control, .form-select, input[type="date"], input[type="time"], input[type="number"] { width: 100%; padding: .875rem 1rem; border: 2px solid #d1d5db; border-radius: 12px; font-size: .95rem; transition: all .3s ease; background: #fff; color: #111827; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
.form-control:focus, .form-select:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="number"]:focus { outline: none; border-color: #01605E; box-shadow: 0 0 0 3px rgba(1,96,94,.1), 0 2px 8px rgba(0,0,0,.15); }
.input-group { display: flex; align-items: stretch; }
.input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }
.input-group-text { display: inline-flex; align-items: center; padding: .875rem 1rem; border: 2px solid #d1d5db; border-left: 0; border-top-right-radius: 12px; border-bottom-right-radius: 12px; background: #f8fafb; font-weight: 600; }

.quantity-control-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f8fafc;
    padding: 0.5rem;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
}

.quantity-control-group input[type="number"] {
    flex: 1;
    text-align: center;
    font-size: 1.25rem;
    font-weight: 700;
    color: #01605E;
    border: none;
    background: white;
    margin: 0;
    box-shadow: none;
}

.quantity-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 2px solid #01605E;
    background: white;
    color: #01605E;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quantity-btn:hover {
    background: #01605E;
    color: white;
    transform: scale(1.05);
}

.quick-quantity {
    padding: 1rem;
    background: #f0f9ff;
    border-radius: 12px;
    border: 1px solid #bae6fd;
}

.datetime-section { background: #f8fafc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #e2e8f0; }
.section-title { color: #01605E; font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
.quick-times { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }

.checkbox-group { display: flex; align-items: center; gap: .75rem; padding: 1rem; background: #f8fafc; border-radius: 12px; }
.checkbox-label { display: flex; align-items: center; gap: .75rem; cursor: pointer; font-weight: 500; color: #374151; }
.checkbox-label input[type="checkbox"] { width: 20px; height: 20px; accent-color: #01605E; cursor: pointer; }

.form-actions { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; }
.btn-primary { background: #01605E; color: #fff; border: none; border-radius: 12px; padding: 1rem 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all .3s ease; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(1,96,94,.2); }
.btn-primary:hover { background: #014a47; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(1,96,94,.3); }
.btn-secondary { background: transparent; color: #6b7280; border: 2px solid #d1d5db; border-radius: 12px; padding: 1rem 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all .3s ease; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; }
.btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; color: #374151; text-decoration: none; }

.form-text { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
.invalid-feedback { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; }

@media (max-width: 768px) {
  .login-wrapper { flex-direction: column; }
  .login-left { min-height: 30vh; }
  .text-line { font-size: 2rem; }
  .login-right { padding: 2rem 1.5rem; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Quantity management
function changeQuantity(delta) {
    const quantityInput = document.getElementById('id_quantity');
    let currentValue = parseInt(quantityInput.value) || 0;
    let newValue = Math.max(0, currentValue + delta);
    quantityInput.value = newValue;
    updatePreview();
}

function setQuantity(value) {
    document.getElementById('id_quantity').value = value;
    updatePreview();
}

// Price calculation
function calculatePrice() {
    const originalPrice = parseFloat(document.getElementById('id_original_price').value) || 0;
    const discountPercent = parseFloat(document.getElementById('id_discount_percent').value) || 0;
    
    if (originalPrice > 0) {
        const discountAmount = (originalPrice * discountPercent) / 100;
        const finalPrice = originalPrice - discountAmount;
        
        document.getElementById('final-price').value = finalPrice.toFixed(0);
        document.getElementById('preview-original').textContent = originalPrice.toFixed(0);
        document.getElementById('preview-discount').textContent = discountPercent.toFixed(0);
        document.getElementById('preview-final').textContent = finalPrice.toFixed(0);
        
        updateDateTimePreview();
        updateQuantityPreview();
        document.getElementById('price-preview').style.display = 'block';
    } else {
        document.getElementById('price-preview').style.display = 'none';
    }
}

function updateDateTimePreview() {
    const startDate = document.getElementById('id_start_date').value;
    const startTime = document.getElementById('id_start_time').value;
    const endDate = document.getElementById('id_end_date').value;
    const endTime = document.getElementById('id_end_time').value;
    
    let periodText = '';
    
    if (startDate && startTime) {
        periodText = `с ${formatDate(startDate)} ${startTime}`;
        
        if (endDate && endTime) {
            periodText += ` до ${formatDate(endDate)} ${endTime}`;
        } else if (endDate) {
            periodText += ` до ${formatDate(endDate)}`;
        } else {
            periodText += ' (бессрочно)';
        }
    }
    
    document.getElementById('preview-period').textContent = periodText;
}

function updateQuantityPreview() {
    const quantity = parseInt(document.getElementById('id_quantity').value) || 0;
    const quantityText = quantity === 0 ? 'Неограниченно' : quantity;
    document.getElementById('preview-quantity').textContent = quantityText;
}

function updatePreview() {
    calculatePrice();
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const options = { day: 'numeric', month: 'short' };
    return date.toLocaleDateString('ru-RU', options);
}

function setTimePreset(preset) {
    const today = new Date().toISOString().split('T')[0];
    
    switch(preset) {
        case 'morning':
            document.getElementById('id_start_time').value = '09:00';
            document.getElementById('id_end_time').value = '12:00';
            if (!document.getElementById('id_end_date').value) {
                document.getElementById('id_end_date').value = today;
            }
            break;
        case 'lunch':
            document.getElementById('id_start_time').value = '12:00';
            document.getElementById('id_end_time').value = '15:00';
            if (!document.getElementById('id_end_date').value) {
                document.getElementById('id_end_date').value = today;
            }
            break;
        case 'evening':
            document.getElementById('id_start_time').value = '18:00';
            document.getElementById('id_end_time').value = '21:00';
            if (!document.getElementById('id_end_date').value) {
                document.getElementById('id_end_date').value = today;
            }
            break;
        case 'allday':
            document.getElementById('id_start_time').value = '00:00';
            document.getElementById('id_end_time').value = '23:59';
            break;
    }
    
    updatePreview();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('id_original_price').addEventListener('input', updatePreview);
    document.getElementById('id_discount_percent').addEventListener('input', function() {
        const value = parseFloat(this.value);
        if (value > 100) this.value = 100;
        else if (value < 0) this.value = 0;
        updatePreview();
    });
    
    document.getElementById('id_quantity').addEventListener('input', updatePreview);
    
    ['id_start_date', 'id_start_time', 'id_end_date', 'id_end_time'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updatePreview);
        }
    });
    
    updatePreview();
});

// Quick discount buttons
function setDiscount(percent) {
    document.getElementById('id_discount_percent').value = percent;
    updatePreview();
}

document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('quick-discounts');
    if (container) {
        container.innerHTML = `
            <small class="text-muted d-block mb-1">Быстрый выбор:</small>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-success" onclick="setDiscount(10)">10%</button>
                <button type="button" class="btn btn-outline-success" onclick="setDiscount(20)">20%</button>
                <button type="button" class="btn btn-outline-success" onclick="setDiscount(30)">30%</button>
                <button type="button" class="btn btn-outline-success" onclick="setDiscount(50)">50%</button>
            </div>
        `;
    }
});
</script>
{% endblock %}