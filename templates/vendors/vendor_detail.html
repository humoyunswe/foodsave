{% extends 'base.html' %}
{% load static %}

{% block title %}{{ vendor.name }} - FoodSave{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Vendor Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="row g-0">
                    <div class="col-md-4">
                        {% if vendor.logo %}
                        <img src="{{ vendor.logo.url }}" class="img-fluid rounded-start h-100" 
                             alt="{{ vendor.name }}" style="object-fit: cover; min-height: 250px;">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center rounded-start h-100" 
                             style="min-height: 250px;">
                            <i class="fas fa-store fa-4x text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <div class="card-body h-100 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h2 class="card-title">{{ vendor.name }}</h2>
                                    <p class="text-muted mb-2">{{ vendor.get_vendor_type_display }}</p>
                                    <div id="vendor-distance" class="text-muted small">
                                        <i class="fas fa-map-marker-alt me-1"></i>Определяем расстояние...
                                    </div>
                                </div>
                                <div class="text-end">
                                    {% if vendor.is_active %}
                                    <span class="badge bg-success fs-6">Открыто</span>
                                    {% else %}
                                    <span class="badge bg-secondary fs-6">Закрыто</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <p class="card-text">{{ vendor.description }}</p>
                            
                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="rating me-2">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= vendor.rating|floatformat:0|default:4 %}
                                                <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                <i class="far fa-star text-muted"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <span class="text-muted">({{ vendor.rating|default:"4.2" }}) • 150+ отзывов</span>
                                    </div>
                                    <div class="text-muted" id="working-hours">
                                        <i class="fas fa-clock me-2"></i>Доставка: 30-45 мин
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    {% if vendor.phone %}
                                    <div class="text-muted mb-2">
                                        <i class="fas fa-phone me-2"></i>{{ vendor.phone }}
                                    </div>
                                    {% endif %}
                                    {% if vendor.address %}
                                    <div class="text-muted">
                                        <i class="fas fa-map-marker-alt me-2"></i>{{ vendor.address }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mt-auto">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="toggleFavorite({{ vendor.id }})">
                                        <i class="fas fa-heart me-2"></i>В избранное
                                    </button>
                                    <button class="btn btn-outline-info" onclick="shareVendor()">
                                        <i class="fas fa-share me-2"></i>Поделиться
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Menu Section with Filters -->
    <div class="row">
        <!-- Filter Sidebar -->
        <div class="col-lg-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Фильтры
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold">Поиск блюд</label>
                        <input type="search" id="menuSearch" class="form-control form-control-sm" 
                               placeholder="Введите название блюда...">
                    </div>
                    
                    <!-- Categories Filter -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold">Категории</label>
                        <div id="categoryFilters">
                            <!-- Categories will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Price Range Filter -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold">Цена</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" id="minPrice" class="form-control form-control-sm" 
                                       placeholder="От" min="0">
                            </div>
                            <div class="col-6">
                                <input type="number" id="maxPrice" class="form-control form-control-sm" 
                                       placeholder="До" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability Filter -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold">Наличие</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="availableOnly" checked>
                            <label class="form-check-label small" for="availableOnly">
                                Только в наличии
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="discountOnly">
                            <label class="form-check-label small" for="discountOnly">
                                Только со скидкой
                            </label>
                        </div>
                    </div>
                    
                    <!-- Clear Filters -->
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Очистить фильтры
                    </button>
                </div>
            </div>
            
            <!-- Branches -->
            {% if branches %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Филиалы</h6>
                </div>
                <div class="card-body">
                    {% for branch in branches %}
                    <div class="mb-3 branch-item {% if not forloop.last %}border-bottom pb-3{% endif %}">
                        <h6 class="mb-1">{{ branch.name }}</h6>
                        <small class="text-muted d-block">{{ branch.address }}</small>
                        <div class="branch-distance text-primary small fw-bold">
                            <i class="fas fa-map-marker-alt me-1"></i>Определяем...
                        </div>
                        {% if branch.phone %}
                        <small class="text-muted d-block">
                            <i class="fas fa-phone me-1"></i>{{ branch.phone }}
                        </small>
                        {% endif %}
                        <div class="branch-hours">
                            <small class="text-muted hours-text">
                                <i class="fas fa-clock me-1"></i>{{ branch.working_hours|default:"Уточняйте время работы" }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Cart -->
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Корзина</h6>
                    <span class="badge bg-primary" id="cart-count">0</span>
                </div>
                <div class="card-body">
                    <div id="quickCart">
                        <div class="text-center text-muted" id="emptyCartMessage">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p class="small">Корзина пуста</p>
                        </div>
                        <div id="cartItems" style="display: none;">
                            <!-- Cart items will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3" id="cartActions" style="display: none;">
                        <a href="{% url 'booking:cart' %}" class="btn btn-primary">
                            <i class="fas fa-shopping-cart me-2"></i>Перейти в корзину
                        </a>
                        <a href="{% url 'booking:checkout' %}" class="btn btn-success">
                            <i class="fas fa-credit-card me-2"></i>Оформить заказ
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Menu Items -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Меню</h5>
                            <small class="text-muted" id="resultsCount">Найдено {{ items|length }} блюд</small>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                                <option value="default">По умолчанию</option>
                                <option value="price_asc">Цена: по возрастанию</option>
                                <option value="price_desc">Цена: по убыванию</option>
                                <option value="name_asc">Название: А-Я</option>
                                <option value="name_desc">Название: Я-А</option>
                                <option value="discount">Сначала со скидкой</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if items %}
                    <div class="row" id="menuItems">
                        {% for item in items %}
                        <div class="col-md-6 col-xl-4 mb-4 menu-item" 
                             data-category="{% if item.category %}{{ item.category.slug }}{% endif %}"
                             data-title="{{ item.title|lower }}"
                             data-price="{% if item.get_active_offer %}{{ item.get_active_offer.current_price }}{% else %}0{% endif %}"
                             data-has-discount="{% if item.get_active_offer and item.get_active_offer.discount_percent > 0 %}true{% else %}false{% endif %}"
                             data-available="{% if item.get_active_offer %}true{% else %}false{% endif %}">
                            <div class="card h-100 menu-item-card">
                                {% if item.images.first %}
                                <img src="{{ item.images.first.image.url }}" class="card-img-top" 
                                     alt="{{ item.title }}" style="height: 180px; object-fit: cover;">
                                {% else %}
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=300&fit=crop" class="card-img-top" 
                                     alt="{{ item.title }}" style="height: 180px; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Discount Badge -->
                                {% if item.get_active_offer and item.get_active_offer.discount_percent > 0 %}
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-danger">-{{ item.get_active_offer.discount_percent }}%</span>
                                </div>
                                {% endif %}
                                
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">{{ item.title }}</h6>
                                    <p class="card-text text-muted small">{{ item.description|truncatewords:10 }}</p>
                                    
                                    <div class="mb-2">
                                        {% if item.category %}
                                        <span class="badge bg-light text-dark me-1">
                                            <i class="fas fa-tag me-1"></i>{{ item.category.name }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if item.branch %}
                                        <span class="badge bg-info text-white me-1">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ item.branch.name }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if item.unit %}
                                        <span class="badge bg-secondary">{{ item.unit }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if item.get_active_offer %}
                                    <div class="mb-2">
                                        <small class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Осталось: {{ item.get_active_offer.quantity_remaining }} шт.
                                        </small>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="price">
                                                {% if item.get_active_offer %}
                                                <span class="h6 text-primary">{{ item.get_active_offer.current_price|floatformat:0 }} сум</span>
                                                {% if item.get_active_offer.discount_percent > 0 %}
                                                <small class="text-muted text-decoration-line-through ms-1">
                                                    {{ item.get_active_offer.original_price|floatformat:0 }} сум
                                                </small>
                                                {% endif %}
                                                {% else %}
                                                <span class="h6 text-muted">Нет в наличии</span>
                                                {% endif %}
                                            </div>
                                            {% if item.get_active_offer %}
                                            <button class="btn btn-primary btn-sm add-to-cart-btn" 
                                                    data-offer-id="{{ item.get_active_offer.id }}"
                                                    data-title="{{ item.title }}"
                                                    data-price="{{ item.get_active_offer.current_price }}">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn btn-secondary btn-sm" disabled>
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- No Results Message -->
                    <div id="noResults" class="text-center py-5" style="display: none;">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>Ничего не найдено</h5>
                        <p class="text-muted">Попробуйте изменить параметры поиска</p>
                    </div>
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                        <h5>Меню пока не добавлено</h5>
                        <p class="text-muted">Ресторан работает над наполнением меню</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.menu-item-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    position: relative;
}

.menu-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.rating .fas.fa-star {
    color: #ffc107;
}

.add-to-cart-btn {
    transition: all 0.2s ease;
}

.add-to-cart-btn:hover {
    transform: scale(1.1);
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.badge {
    font-size: 0.7em;
}

.menu-item {
    transition: opacity 0.3s ease;
}

.menu-item.hidden {
    display: none !important;
}

#categoryFilters .form-check {
    margin-bottom: 0.5rem;
}

.sticky-top {
    z-index: 1020;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}"></script>
<script>
// Global variables
let userLocation = null;
let branches = {{ branches_json|safe }};
let allItems = [];
let filteredItems = [];

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    initializeFilters();
    updateQuickCart();
    
    // Add to cart buttons
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const offerId = this.dataset.offerId;
            const title = this.dataset.title;
            const price = parseFloat(this.dataset.price);
            
            addToCart(offerId, title, price);
            showNotification('Товар добавлен в корзину!', 'success');
            updateQuickCart();
            updateCartCount();
        });
    });
});

function initializePage() {
    // Auto-detect location and calculate distances
    autoDetectLocation();
    
    // Load working hours for branches
    loadWorkingHours();
    
    // Collect all menu items data
    collectMenuItems();
}

function collectMenuItems() {
    const menuItemElements = document.querySelectorAll('.menu-item');
    allItems = Array.from(menuItemElements).map(item => ({
        element: item,
        category: item.dataset.category || '',
        title: item.dataset.title || '',
        price: parseFloat(item.dataset.price) || 0,
        hasDiscount: item.dataset.hasDiscount === 'true',
        available: item.dataset.available === 'true'
    }));
    filteredItems = [...allItems];
}

function initializeFilters() {
    // Collect unique categories
    const categories = [...new Set(allItems.map(item => item.category).filter(cat => cat))];
    
    // Populate category filters
    const categoryFiltersContainer = document.getElementById('categoryFilters');
    categoryFiltersContainer.innerHTML = '';
    
    categories.forEach(category => {
        const categoryName = getCategoryDisplayName(category);
        const itemCount = allItems.filter(item => item.category === category).length;
        
        const checkboxHtml = `
            <div class="form-check">
                <input class="form-check-input category-filter" type="checkbox" 
                       id="cat_${category}" value="${category}" checked>
                <label class="form-check-label small" for="cat_${category}">
                    ${categoryName} (${itemCount})
                </label>
            </div>
        `;
        categoryFiltersContainer.innerHTML += checkboxHtml;
    });
    
    // Add event listeners
    setupFilterEventListeners();
}

function getCategoryDisplayName(categorySlug) {
    // Map category slugs to display names
    const categoryMap = {
        'appetizers': 'Закуски',
        'main': 'Основные блюда',
        'desserts': 'Десерты',
        'drinks': 'Напитки',
        'salads': 'Салаты',
        'soups': 'Супы',
        'pizza': 'Пицца',
        'burgers': 'Бургеры'
    };
    
    // Try to get display name from the DOM
    const categoryElement = document.querySelector(`[data-category="${categorySlug}"] .badge`);
    if (categoryElement) {
        return categoryElement.textContent.replace(/^\s*\S+\s*/, ''); // Remove icon
    }
    
    return categoryMap[categorySlug] || categorySlug.charAt(0).toUpperCase() + categorySlug.slice(1);
}

function setupFilterEventListeners() {
    // Search input
    document.getElementById('menuSearch').addEventListener('input', applyFilters);
    
    // Category checkboxes
    document.querySelectorAll('.category-filter').forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
    });
    
    // Price inputs
    document.getElementById('minPrice').addEventListener('input', applyFilters);
    document.getElementById('maxPrice').addEventListener('input', applyFilters);
    
    // Availability checkboxes
    document.getElementById('availableOnly').addEventListener('change', applyFilters);
    document.getElementById('discountOnly').addEventListener('change', applyFilters);
    
    // Sort select
    document.getElementById('sortSelect').addEventListener('change', applySorting);
}

function applyFilters() {
    const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
    const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
    const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
    const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
    const availableOnly = document.getElementById('availableOnly').checked;
    const discountOnly = document.getElementById('discountOnly').checked;
    
    filteredItems = allItems.filter(item => {
        // Search filter
        if (searchTerm && !item.title.includes(searchTerm)) {
            return false;
        }
        
        // Category filter
        if (selectedCategories.length > 0 && !selectedCategories.includes(item.category)) {
            return false;
        }
        
        // Price filter
        if (item.price < minPrice || item.price > maxPrice) {
            return false;
        }
        
        // Availability filter
        if (availableOnly && !item.available) {
            return false;
        }
        
        // Discount filter
        if (discountOnly && !item.hasDiscount) {
            return false;
        }
        
        return true;
    });
    
    updateDisplay();
}

function applySorting() {
    const sortValue = document.getElementById('sortSelect').value;
    
    switch (sortValue) {
        case 'price_asc':
            filteredItems.sort((a, b) => a.price - b.price);
            break;
        case 'price_desc':
            filteredItems.sort((a, b) => b.price - a.price);
            break;
        case 'name_asc':
            filteredItems.sort((a, b) => a.title.localeCompare(b.title));
            break;
        case 'name_desc':
            filteredItems.sort((a, b) => b.title.localeCompare(a.title));
            break;
        case 'discount':
            filteredItems.sort((a, b) => {
                if (a.hasDiscount && !b.hasDiscount) return -1;
                if (!a.hasDiscount && b.hasDiscount) return 1;
                return 0;
            });
            break;
        default:
            // Default order - no sorting
            break;
    }
    
    updateDisplay();
}

function updateDisplay() {
    const menuContainer = document.getElementById('menuItems');
    const noResults = document.getElementById('noResults');
    const resultsCount = document.getElementById('resultsCount');
    
    // Hide all items first
    allItems.forEach(item => {
        item.element.classList.add('hidden');
    });
    
    if (filteredItems.length === 0) {
        noResults.style.display = 'block';
        resultsCount.textContent = 'Ничего не найдено';
    } else {
        noResults.style.display = 'none';
        resultsCount.textContent = `Найдено ${filteredItems.length} блюд`;
        
        // Show filtered items in order
        filteredItems.forEach((item, index) => {
            item.element.classList.remove('hidden');
            item.element.style.order = index;
        });
    }
}

function clearAllFilters() {
    // Reset search
    document.getElementById('menuSearch').value = '';
    
    // Check all categories
    document.querySelectorAll('.category-filter').forEach(cb => cb.checked = true);
    
    // Reset price inputs
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    
    // Reset availability filters
    document.getElementById('availableOnly').checked = true;
    document.getElementById('discountOnly').checked = false;
    
    // Reset sorting
    document.getElementById('sortSelect').value = 'default';
    
    // Reapply filters
    applyFilters();
    
    showNotification('Фильтры очищены', 'info');
}

function addToCart(offerId, title, price) {
    const cart = JSON.parse(localStorage.getItem('foodsave_cart')) || [];
    const existingItem = cart.find(item => item.offerId === offerId);
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({
            offerId,
            title,
            price,
            quantity: 1
        });
    }
    
    localStorage.setItem('foodsave_cart', JSON.stringify(cart));
}

function updateCartCount() {
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
        const cart = JSON.parse(localStorage.getItem('foodsave_cart')) || [];
        cartCount.textContent = cart.length;
    }
}
</script>
{% endblock %}
